version: 1.1
workflow: github-flow
roll:
  pulse:
    - on:
        cycle:
          range: (20s, 2m)
          reset:
            - push
      then:
        - fetch: origin
  tbs:
    - then:
        - squash: tbs
        - push: origin
  complete:
    - on:
        worktree:
          head:
            branch!: master
            merged!: origin/master
      then:
        - commit: force
        - squash
        - push: origin
        - cmd:
            args: hub pull-request --no-edit
            timeout: 1m
  worktreeChanged:
    - on:
        worktree:
          clean: false
          head:
            branch: master
      then:
        - newBranch
    - on:
        worktree:
          clean: false
          head:
            branch!: master
      then:
        - commit
        - squash
        - push: origin
  branchUpdated,branchCreated:
    - on:
        branch: master
        remote: origin
        worktree:
          clean: true
          head:
            branch: master
      then:
        - pull: origin
        - cleanMergedBranches: origin/master
    - on:
        branch: master
        remote: origin
        worktree:
          clean: true
          head:
            branch!: master
            merged: origin/master
      then:
        - checkout: master
        - pull: origin/master
        - cleanMergedBranches: origin/master
